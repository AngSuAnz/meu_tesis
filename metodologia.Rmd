---
title: "Metodología de investigación"
description: |
  Caso de estudio: Barrio Padre Carlos Mugica y su entorno formal
---

  
```{r librerias, include=FALSE}

options(scipen = 999)

library(bootstrap)
library(bslib)
library(data.table)
library(dplyr)
library(DT)
library(geofacet)
library(ggmap)
library(ggplot2)
library(googlesheets4)
library(installr)
library(janitor)
library(knitr)
library(leaflet)
library(leaflet.extras)
library(lubridate)
library(lwgeom)
library(maptools)
library(openxlsx)
library(osmdata)
library(osrm)
library(plotly)
library(purrr)
library(RColorBrewer)
library(readxl)
library(readr)
library(rgdal)
library(rgeos)
library(rmarkdown)
library(rsconnect)
library(scales)
library(sf)
#library(shiny)
#library(shinydashboard)
#library(shinyjs)
library(sodium)
library(sp)
library(stringr)
library(tidygeocoder)
library(tidyr)
library(tidyverse)
library(viridis)
library(viridisLite)
library(vroom)
library(writexl)

#In RStudio, you can render your site locally (knit + preview all .Rmd files in one fell swoop). Se puede escribir en la consola: rmarkdown::render_site()  SIEMPRE HACER ESTO PARA IMPACTAR LOS CAMBIOS EN EL SITIO!

```

```{r exclude_false, include=FALSE}
knitr::opts_chunk$set(
  comment =FALSE,
  #fig.width = 6, fig.height = 6, 
  message=FALSE, warning=FALSE
)
```

```{r, include=FALSE}
gotop::use_gotop(
  src = "fas fa-chevron-circle-up", # css class from Font Awesome
  color = "tomato", # color
  opacity = 0.8, # transparency
  width = 30, # size
  appear = 100 # number of pixels before appearance
  )
```
<script>
function initTableSettings() {
  $('.searchable-table').each(function () {  // Only apply to tables with "searchable-table" class
    var table = $(this).DataTable();
    table.columns().every(function () {
      var column = this;
      var header = $(column.header());
      var input = $('<br><input type="text" placeholder="Filter" style="width: 75%;"/>').appendTo(header).on('keyup change', function () {
        if (column.search() !== this.value) {
          column.search(this.value).draw();
        }
      });
    });
  });
}

$(document).ready(function() {
  initTableSettings();
});
</script>


Acá hago una intro épica para mi tema de tesis.


<h2>
  PRIMER PASO </br>
  <small class="text-muted"> |  La unidad territorial </small>
</h2>

Tomo el polígono del barrio Padres Carlos Mugica y el de la ciudad de Buenos Aires.

Como el objetivo es observar el acceso a la ciudad que tiene el Barrio Mugica en comparación a la ciudad formal circundante, comienzo creando un buffer a 1500 metros del Barrio Mugica, y tomo los radios censales (censo 2022) que se intersectan con el mismo.

<details><summary> Código </summary> 
```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
#CARGO LAS BASES
ciudad = st_read("data/perimetro.geojson") %>% 
  #mutate(AREAKM2 = round((AREA/1000000),2)) %>% 
  st_transform(4326)%>% 
  st_make_valid()

#colectivos_paradas = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/transporte-y-obras-publicas/colectivos-paradas/paradas-de-colectivo.geojson") %>% 
#  st_transform(4326)

b_mugica_sectores = st_read("data/sector.shp")

b_mugica <- st_buffer(st_union(b_mugica_sectores), 0.5) %>%
  st_sf() %>%  # convert to sf object with geometry column
  st_transform(4326) %>%
  mutate(area_km2 = as.numeric(st_area(geometry)) / 1e6)
  
#EDITO EL POLIGONO DE LA CIUDAD PARA DESCONTARLE EL BARRIO:
ciudad_cfiltro = st_difference(ciudad, b_mugica)
```

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
#Creo un buffer en torno al barrio para seleccionar los radios sensales próximos:
b_buffer <- st_buffer(b_mugica, dist = 1500)

#Llamo y filtro los radios en base a ese buffer. Llamo una sola vez la base original porque es muy pesada.
#radios_censales = st_read("data/radios_censales.shp", options = "ENCODING=LATIN1")%>% 
#                    st_transform(4326) %>% 
#  filter(jur == "Ciudad Autónoma De Buenos Aires")

#st_write(radios_censales, "data/radios_censales_filtrados.geojson")

radios_censales = st_read("data/radios_censales_filtrados.geojson")

b_buffer <- st_transform(b_buffer, st_crs(radios_censales))

b_buffer = st_intersection(b_buffer,ciudad)

radios_filtrados <- st_filter(radios_censales, b_buffer)
```
</details>

Imagen 1. Ciudad Autónoma de Buenos Aires, polígono del Barrio Padre Carlos Mugica definido en la ley N° 6.129 (2018) y buffer de 1500m en torno al mismo.

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
mapa_ciudad_buffer =
leaflet(st_zm(ciudad)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("CABA","Buffer Barrio Mugica","Barrio Mugica" ))%>% 
  
  addPolygons(data= ciudad,
              color = "black",
              weight = 1,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0,
              group = "CABA") %>% 

  addPolygons(data= b_buffer,
              color = "black",
              weight = 0.6,
              opacity = 0.7,
              fillColor = "#a64d79",
              fillOpacity = 0.3,
              popup = "<strong>BUFFER BARRIO - DISTANCIA:</strong>1500m",
              group = "Buffer Barrio Mugica") %>% 

  
  addPolygons(data= b_mugica,
              color = "black",
              weight = 0.8,
              opacity = 0.7,
              fillColor = "#a64d79",
              fillOpacity = 0.4,
              popup = ~paste("<strong>BARRIO P. MUGICA - AREA:</strong>", round(area_km2, 3), "km2"),
              group = "Barrio Mugica")
    
mapa_ciudad_buffer
```

Imagen 2. Radios Censales que se intersectan con el buffer (imagen 2) 

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
mapa_radios =
leaflet(st_zm(ciudad)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Radios Censales","CABA","Barrio Mugica" ))%>% 
  
  addPolygons(data= ciudad,
              color = "black",
              weight = 1,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0,
              group = "CABA") %>% 
  
  addPolygons(data= b_mugica,
              color = "black",
              weight = 0.8,
              opacity = 0.7,
              fillColor = "#a64d79",
              fillOpacity = 0.4,
              popup = ~paste("<strong>AREA KM2:</strong>", round(area_km2, 3)),
              group = "Barrio Mugica") %>% 


  addPolygons(data= radios_filtrados,
              color = "black",
              weight = 0.6,
              opacity = 0.7,
              fillColor = "#a2c4c9",
              fillOpacity = 0.5,
              popup = ~paste("<strong> ID: </strong>", id),
              group = "Radios Censales") 

mapa_radios
```

En base a eso, excluyo ciertos radios donde no predomina el uso residencial, ya que lo que busco observar es el acceso que tienen las personas desde sus viviendas a los servicios urbanos. Los resultantes serán los radios que comprenden el Barrio Mugica, y los sectores que cuentan con la proximidad suficiente como para considerarse el entorno urbano formal al que debe integrarse la urbanización informal.
Para filtrar los radios censales calculo la densidad de viviendas por radio censal y excluyo aquellos cuyo valor es menor a 3500.

El mapa resultante es el siguiente:

<details><summary> Código </summary>
```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
viviendas = read_excel("data/_tmp_11601061.xlsx", sheet = "data") %>% 
  rename("viviendas" = "C1", "cod_indec" = "Código") %>% 
  mutate(cod_indec = as.character(cod_indec),
         cod_indec = paste0("0",cod_indec))

radios_viviendas = left_join(radios_filtrados, viviendas, by = "cod_indec") %>% 
  mutate(area_km2 = round(as.numeric(st_area(geometry)) / 1e6,4),
         densidad_viviendas = round(viviendas/area_km2,2)) %>% 
  filter(densidad_viviendas > 3500) %>%
  filter(!id %in% c("72473", "72474", "72419", "72418", "72557", "26526","50645","50665"))

radios_informal = st_filter(radios_viviendas, b_mugica) %>% 
  mutate(formal = "0") %>% 
  st_drop_geometry() %>% 
  select("cod_indec","formal")

radios_selec = left_join(radios_viviendas, radios_informal, by = "cod_indec") %>% 
  mutate(formal = if_else(is.na(formal), "1", formal))

```
</details>

Imagen 3. Radios censales seleccionados.

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}

radios_selec$formal <- as.factor(radios_selec$formal)

pal_formal <- colorFactor(
  palette = c("0" = "#a64d79", "1" = "#a2c4c9"),
  domain = radios_selec$formal)


mapa_radios =
leaflet(st_zm(ciudad)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Radios Censales","CABA"))%>% 
  
  addPolygons(data= ciudad,
              color = "black",
              weight = 1,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0,
              group = "CABA") %>%

  addPolygons(data= radios_selec,
              color = "black",
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal_formal(formal),
              fillOpacity = 0.5,
              popup = ~paste("<strong> ID: </strong>", id,"<br><strong>DENSIDAD VIVIENDAS:</strong>", densidad_viviendas,"<br><strong>FORMAL:</strong>", formal),
              group = "Radios Censales") 

mapa_radios
```

Calculo la sumatoria de los radios formales elegidos, y la divido entre el área del Barrio Mugica para agrupar los radios en "sectores próximos", y conformar así unidades comparables.

<details><summary> Código </summary>
```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
radios_formal = radios_selec %>% 
  filter(formal == "1")

area_formal = radios_formal %>% 
  summarise(area_km2=sum(area_km2))

cantidad_sectores_prox = area_formal$area_km2/b_mugica$area_km2

cantidad_sectores_prox

#OBTENGO LOS CENTROIDES Y SUS COORDENADAS
centros <- st_centroid(radios_formal) %>% 
  st_coordinates()

# 3. Aplicar k-means
set.seed(123)  # Para reproducibilidad
kmeans_result <- kmeans(centros, centers = 6)

# 4. Agregar los clusters al objeto original
sectores_prox = radios_formal
sectores_prox$cluster = kmeans_result$cluster

radios_informal = radios_selec %>% 
  filter(formal == "0")

```
</details>

Los sectores próximos se agrupan entonces de la siguiente manera, y serán comparadas sus características con las del Barrio Mugica:

Imagen 5. Radios censales seleccionados agrupados en el Barrio Mugica y 6 sectores próximos.

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}

pal = colorFactor("Blues", domain = sectores_prox$cluster)

mapa_sectores =
leaflet(st_zm(sectores_prox)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Sectores Proximos","Barrio Mugica"))%>% 
  
  addPolygons(data= radios_informal,
              color = "black",
              weight = 1,
              opacity = 0.7,
              fillColor = "#a64d79",
              fillOpacity = 0.5,
              popup = ~paste("<strong> ID: </strong>", id,"<br><strong>DENSIDAD VIVIENDAS:</strong>", densidad_viviendas,"<br><strong>FORMAL:</strong>", formal),
              group = "Barrio Mugica") %>%

  addPolygons(data= sectores_prox,
              color = "black",
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.5,
              popup = ~paste("<strong> ID: </strong>", id,"<br><strong>DENSIDAD VIVIENDAS:</strong>", densidad_viviendas,"<br><strong>FORMAL:</strong>", formal,"<br><strong>CLUSTER:</strong>", cluster),
              group = "Sectores Proximos") 

mapa_sectores
```


Isocronas

<details><summary> Código </summary>
```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
#LLAMO A LOS SECTORES DEL BARRIO MUGICA PARA QUE LOS PUNTOS ALEATORIOS ESTÉN MÁS DISTRIBUIDOS. TODA ESTA PARTE LA HAGO UNA SOLA VEZ.

#GENERO Y GUARDO LOS PTOS ALEATORIOS PORQUE SINO CADA VEZ QUE CORRO EL CODIGO, SON NUEVOS:
#puntos_aleatorios_bm <- rowwise(b_mugica_sectores) %>%
#  mutate(punto_aleatorio = st_sample(geometry, 1, type = "random")) %>% 
#  st_drop_geometry(geometry) %>% 
#  st_as_sf()

#GUARDO LOS PUNTOS PARA LLAMARLOS DESPUES:
#st_write(puntos_aleatorios_bm, "data/puntos_aleatorios_bm.geojson")

#LLAMO A LOS PUNTOS ALEATORIOS GUARDADOS DEL BARRIO MUGICA:
puntos_aleatorios_bm = st_read("data/puntos_aleatorios_bm.geojson") %>% 
  st_transform(4326) %>% 
  clean_names() %>% 
  filter(sector %in% c("CO", "SM", "YP", "PO", "IN"))

#CONSTRUYO ISOCRONAS DE 15M
#lista_isocronas_bm_15 <- lapply(puntos_aleatorios_bm$geometry, function(point) {
#  osrmIsochrone(loc = st_coordinates(point),
#                breaks = seq(from = 0, to = 15, by = 15),
#                res = 40,
#                osrm.profile = "foot")
#})

#Combino las isocronas
#isocronas15_bm = do.call(rbind, lista_isocronas_bm_15)

#st_write(isocronas15_bm, "data/isocronas15.3_bm.geojson")

isocronas15_bm = st_read("data/isocronas15.3_bm.geojson")%>% 
                    st_transform(4326) %>% 
                    #cbind(st_drop_geometry(centroides)) %>% 
                    st_make_valid()%>% 
                    mutate(id = row_number())
```
```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}
#ISOCRONAS SECTORES PROXIMOS
sectores_contorno = sectores_prox %>% 
  group_by(cluster) %>% 
  summarise()

ggplot(sectores_contorno) +
  geom_sf()

#GENERO Y GUARDO LOS PTOS ALEATORIOS PORQUE SINO CADA VEZ QUE CORRO EL CODIGO, SON NUEVOS:
#puntos_aleatorios_sp <- sectores_contorno %>%
#  rowwise() %>%
#  mutate(puntos = list(st_sample(geometry, size = 5, type = "random"))) %>%
#  ungroup() %>%
#  select(-geometry) %>%  # elimina la geometría original
#  unnest(puntos) %>%
#  st_as_sf(coords = "puntos", crs = st_crs(sectores_contorno)) %>% 
#  st_drop_geometry() %>% 
#  rename("geometry"="puntos") %>% 
#  mutate(punto = paste0(cluster,".",row_number()))
  

#GUARDO LOS PUNTOS PARA LLAMARLOS DESPUES:
#st_write(puntos_aleatorios_sp, "data/puntos_aleatorios_sp.geojson")

#LLAMO A LOS PUNTOS ALEATORIOS GUARDADOS DE LOS SECTORES PROXIMOS:
puntos_aleatorios_sp = st_read("data/puntos_aleatorios_sp.geojson") %>% 
  st_transform(4326) %>% 
  clean_names() %>% 
  mutate(id = str_sub(punto, 3))

puntos_aleatorios_sp$id = as.numeric(puntos_aleatorios_sp$id)
#CONSTRUYO ISOCRONAS DE 15M
#lista_isocronas_sp_15 <- lapply(puntos_aleatorios_sp$geometry, function(point) {
#  osrmIsochrone(loc = st_coordinates(point),
#                breaks = seq(from = 0, to = 15, by = 15),
#                res = 40,
#                osrm.profile = "foot")
#})

#Combino las isocronas
#isocronas15_sp = do.call(rbind, lista_isocronas_sp_15)

#st_write(isocronas15_sp, "data/isocronas15_sp.geojson")

isocronas15_sp = st_read("data/isocronas15_sp.geojson")%>% 
                    st_transform(4326) %>% 
                    #cbind(st_drop_geometry(centroides)) %>% 
                    st_make_valid()%>% 
                    mutate(id = row_number())

isocronas15_sp = left_join(isocronas15_sp, puntos_aleatorios_sp %>% 
                                              st_drop_geometry() %>% 
                             select(cluster,id))
```
ggplot(b_buffer) +
  geom_sf()
  
</details>

Imagen 6. Isocronas a 15 minutos a pie desde los puntos aleatotios dentro del Barrio Mugica y de cada uno de los 6 sectores próximos.

```{r, echo=FALSE, out.width='100%', fig.align='left', fig.height = 6}

pal = colorFactor("Blues", domain = sectores_prox$cluster)

mapa_isocronas_tot =
leaflet(st_zm(sectores_prox)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Isocronas Barrio Mugica","Barrio Mugica", "Puntos Aleatorios BM", "Isocronas Sector 1", "Isocronas Sector 2", "Isocronas Sector 3", "Isocronas Sector 4", "Isocronas Sector 5", "Isocronas Sector 6", "Sectores Proximos", "Puntos Aleatorios SP"))%>% 
  
  addPolygons(data= isocronas15_bm,
              color = "#a64d79",
              weight = 1,
              opacity = 0.7,
              fillColor = "#a64d79",
              fillOpacity = 0.4,
              group = "Isocronas Barrio Mugica") %>%
  

  addPolygons(data= b_mugica,
              color = "black",
              weight = 1,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0,
              group = "Barrio Mugica") %>%

  addPolygons(data= isocronas15_sp %>% filter(cluster=="1"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 1") %>% 
  
    addPolygons(data= isocronas15_sp%>% filter(cluster=="2"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 2") %>% 
  
    addPolygons(data= isocronas15_sp%>% filter(cluster=="3"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 3") %>% 
  
    addPolygons(data= isocronas15_sp %>% filter(cluster=="4"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 4") %>% 
  
    addPolygons(data= isocronas15_sp %>% filter(cluster=="5"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 5") %>% 
  
    addPolygons(data= isocronas15_sp %>% filter(cluster=="6"),
              color = ~pal(cluster),
              weight = 0.6,
              opacity = 0.7,
              fillColor = ~pal(cluster),
              fillOpacity = 0.4,
              group = "Isocronas Sector 6") %>% 

  addPolygons(data= sectores_contorno,
              color = "black",
              weight = 0.6,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0,
              group = "Sectores Proximos") %>% 
  
    addCircleMarkers(data=puntos_aleatorios_bm,
              fillColor = "black",
              weight = 0.5,
              color = "black",
              fillOpacity = 0.5,
              radius = 2,
              group = "Puntos Aleatorios BM") %>%

  addCircleMarkers(data=puntos_aleatorios_sp,
              fillColor = "black",
              weight = 0.5,
              color = "black",
              fillOpacity = 0.5,
              radius = 2,
              group = "Puntos Aleatorios SP")

mapa_isocronas_tot
```

